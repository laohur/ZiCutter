from logzero import logger

star = 'Èñµ'

"""
    §çΩ	§ëî k,v  ÂºÇ‰ΩìÂ≠ó\tÊú¨‰ΩìÂ≠ó
    HeZi[§ëî]=HeZi[§çΩ] if §çΩ in §ëî
    HeZi[v]=HeZi[k] if k in v
    """


def split(dic0, JiZi, YiTi, epoch=0):
    giveup = set()
    dic1 = {}
    for k, v in dic0.items():
        if k == star:
            d = 0
        if k in giveup:
            continue
        if v in JiZi:
            dic1[k] = v
            continue
        u = ''
        for x in v:
            w = dic0[x]
            if w not in JiZi:
                w = YiTi.get(w, w)
                if epoch >= 5:
                    giveup.add(k)
                    # logger.info((k, v))
            u += w.strip()
        dic1[k] = u
        for x in giveup:
            if x in dic1:
                del dic1[x]
    logger.info(f"giveup:{len(giveup)} {''.join(giveup)}")
    base0 = set(''.join(x for x in dic0.values()))
    base1 = set(''.join(x for x in dic1.values()))
    logger.info((f"epoch:{epoch} base:{len(base0)} --> {len(base1)} "))
    return dic1


def chai(JiZi: set, ChaiZi: list, YiTiZi: list):
    HeZi = {k: v for k, v in ChaiZi}
    for x in JiZi:
        HeZi[x] = x

    YiTi = {}
    for k, v in YiTiZi:
        if k == star:
            d = 0  # 'Â∏Ω'  Â±ÇÊ¨°ÊãÜÂ≠ó Êñ∞ÊûÑ‰ª∂
        if k in JiZi and v in JiZi:
            continue
        if k in JiZi and v not in JiZi:
            k = v
        YiTi[k] = v

    for k, v in YiTi.items():
        if v not in HeZi:  # vÁΩïËßÅ
            k, v = v, k
        if v not in HeZi:  # vÁΩïËßÅ
            logger.warning((k, v))
            continue
        if k in JiZi:
            continue
        if k in HeZi[v]:  # Êõ¥ÁªÜ
            HeZi[v] = HeZi[k]
        if v in HeZi:
            # if k < v:
            # logger.warning((k, v))
            HeZi[k] = HeZi[v]
        elif k in HeZi:  # None
            # logger.info((k, v)
            continue

    dic0 = {k: v for k, v in HeZi.items() if k and v}

    for i in range(8):
        dic1 = split(dic0, JiZi, YiTi, epoch=i)
        dic0 = dic1

    dic0 = {k: v for k, v in dic0.items() if k and v}
    return dic0


def build(JiZi, ChaiZiPath, YiTiZiPath,  HeZiPath, JiZiPath):
    JiZi = [x for x in JiZi if x]
    JiZi = set(JiZi)

    doc = open(YiTiZiPath).read().splitlines()
    YiTiZi = [x.split('\t') for x in doc]

    doc = open(ChaiZiPath).read().splitlines()
    ChaiZi = [x.split('\t') for x in doc]

    HeZi = chai(JiZi, ChaiZi, YiTiZi)

    Base = set(''.join(x for x in HeZi.values()))

    logger.info(''.join(Base-JiZi))  #
    assert len(set(Base)-JiZi) == 0

    Base = list(Base)
    Base.sort()
    with open(JiZiPath, "w") as f:
        for x in Base:
            f.write(x+'\n')

    chars = list(HeZi)
    chars.sort()
    with open(HeZiPath, "w") as f:
        for x in chars:
            l = f"{x}\t{HeZi[x]}"
            f.write(l+'\n')


if __name__ == "__main__":
    # JiZi = open("YuanZi/YuanZi.txt").read().splitlines()
    # build(JiZi, ChaiZiPath="ChaiZi/ChaiZi.txt", YiTiZiPath="YiTiZi/YiTiZi.txt",
    #       HeZiPath="HeZi/He2Yuan.txt", JiZiPath="HeZi/YuanZi.txt")
    JiZi = open("JiZi/JiZi.txt").read().splitlines()
    build(JiZi, ChaiZiPath="ChaiZi/ChaiZi.txt", YiTiZiPath="YiTiZi/YiTiZi.txt",
          HeZiPath="HeZi/He2Ji.txt", JiZiPath="HeZi/JiZi.txt")


"""
[I 220626 18:07:04 HeZi:36] giveup:0 
[I 220626 18:07:05 HeZi:39] epoch:0 base:8204 --> 2611 
[I 220626 18:07:05 HeZi:36] giveup:0 
[I 220626 18:07:06 HeZi:39] epoch:1 base:2611 --> 1774 
[I 220626 18:07:06 HeZi:36] giveup:0 
[I 220626 18:07:07 HeZi:39] epoch:2 base:1774 --> 1760 
[I 220626 18:07:07 HeZi:36] giveup:0 
[I 220626 18:07:08 HeZi:39] epoch:3 base:1760 --> 1760 
[I 220626 18:07:08 HeZi:36] giveup:0 
[I 220626 18:07:09 HeZi:39] epoch:4 base:1760 --> 1760 
[I 220626 18:07:19 HeZi:36] giveup:1139 ‰∏ùÈé¢¢∂à≠±ê´òô‰≤∑£î∫‰ÉÄ™íúÁôõ°•Ç¶ºØ´≤É´∫Ü‚Ü∑¨Ñí§àÇ´ëöß†ä¢Ö¶´ûºßù•∞ßø§Ω™ÊÜì£ê¶™ûï©êØ°∫ëÆá≠ÈÑ¢†≥≤™∑§‰ôäÆì¢ËâúÂ™¢‚ÑìõÇ¶•≤≠Ëµó©ÉÖ´øù´∏Ä„íø©úù¨ÖÖÆ¢á†ïÆ£ª¥ÔøΩ¨Ñú„Øä„Øä¢Ø´¨êë≠éØÊåî¶°£•ù©®úë¢≤ÑßÇò®™á†Ö§≠ªã
±àØ¶äØ©âæ≠Åê†ùâ¶°øÂ£∫Â£∫¢ªÄ°öá‰°ß≠±éÈüÄ°ñ†ß†Å¨ëì¨ªò≠≠ò¢à∫®ö≤¶áµ¶¶∞ßÆâ≠¶Å∞üÄÂòïßÉπ∞¨¢„íΩ°úåÂª©´∏™≠µÑ£•ã£Ü±±Ä†°¨úÂÜÉ¢Øæ§ìü¨ªû∞Ø≥´ÆñËî∫ÊæüÈûØÊ¢üÆ£®´¶≤¨ü†ÂØ≠¨î®≠°£¶ª∫Ô•î©èáÊãµ§≤±ßòßÂ£∑Â£∑∞≠çÊáçËî´¢ãï®ò¨≠£™ß°âÂ∂ã„¥ò°ÖÅ°ñ™Æíø•ã∂Ëùê°†ø•ïßÈ≥¨•æ≥‰âÆÂáú¢§Öß∑ÑËùÉ 
Æ°≠∞ÖªÁºé¢∫¨¢Æ¥Â∏ΩÈ∑®®Äî©é∞™àΩ§£Ω„ºÆÔ®©£ìù©éá´©äÆë©Èñµ¢Ä§¢ÄÆ¶∫ü≠ä∞≠∏õ¢•ÅË£äÈü¢£∑ëßû°ßÜï¨ä•¶ºá®òÑ©§£ÁÜìÈçõ°úí„ê≠¨ª•¶çñ®í¢Áí§ÂÜêÁ¥™°âà‚ë≠„ØÇÂ°¢®é∫Æú©ËëÆ¨ªë°àå≠ªùËê∫£ñ∫≠ê£ÂÇø†™Ö°úà∞ÇøÊºπÂíù§ö∂´íø≠™öÂΩí†ì∂„≠ö†∞ü¶†ú¨π¢†Üã°™ç´íØ¢û¨†ïôÆîá†ÖÇ„†Ä°ø¢ÊªØß∑ß‚ë¨‰¶Ñ„™ûÔøΩ°æ≠Ê∑íÊ∑í£å∞®∂áÂú®®ΩÖ¨¨¢ÆØÜ∞äé‰Öø≠≤û©èö‚ë°†∞°ÊÖ∏£∂ÄÂ°ÖÈ¥µ¢æü¨∑∂≠ò≤≠¨ç∞Ç∂¨ö¶•ÆÇÈÉªËπõ§æè„íæÊÆµ¢§î¨òÑ™¨¢¶™¥®©∑ßöá≠ê•£ëäÂ¨Ö£∏º£∫è©•ú†ª≠Æöê°©ºÊáîË∫™£ëõËå¨ÆÉû§°îÆúü™õÉ©æí™ä©•©¥£üä©à∫‚ë≤∞®á®Ä¨¨íõ¶Ä©©åµ©ù∑¶Üâ™Çóßãç£ü¶Â≠ò∞ªÆ§Äô¨úª†±Ω´Ç††òÖ¢ã¥≠£®•¢Å†å•≠£ûßÑü‚ëØ¶ëê≠ôßÔøΩ
®â®≠±Ω®∫£Øßä´öò„∏ë„∏ë°ô™†≠ÇÂãó¨ª±•††„íüÁ®ü´ëÄ∞≤û§Ç∂Â≤õÁá∑„íªÂ∂å§¥üßÇ∂È°≤•§Ç†ò°°†π•öï´ñõ‚ë¶©Äµ§úì®í∏≠º™¶ãì£∫ôÆóôßü∫†∞á≠è¨∞∞è≠≤≥„µØ´™Æ´¥¢Ô¶é´öÉ•£º≠£ï§ëá†ó©£ó´£øÜ¶Ø§¶∑ä®∫î´≠£°∑ä‰åØ‰åØ°Øº§éÑ§ï¶„•ºÂ∂πÈ∂à¨Ø∂°Ωº†òü¢≠è‚ë†Áá£¢ùåÊÇΩ≠©ü©åÆ„´Ø¨ÉÖÊâó™ûå†ï•´°øËûÆ≠Ä£‚ë™  
‰ß•†âØ¢≥É£ª•†©ØßÖç†°ò¶áÖ†¶Ω°êù£ªâ´∂á≠©≤ÆÉ¶¨µ™®ìÇ°≠≥´ÉÖ£ØÄ§ì•©æñ†Üø†åµ≠î•¨ä∑È≥≥Ë∫ôÂÜï†åö´ãá¢û®†õÜ†≤ÅÂò©ÈÑ•©¶´¨Äº†±ú®≥Ä„É®§É¢´ùµÆÖè®óçÊ©û•á≥§çæ•ëØ°££©çΩ≠ÇõËΩ•†¨∑¶™∑ÊúÇËûêÈè∏†íé†¨éËüÇ¶á©≠ìÅ¢∑¨£è±¶¢µ¶®ß¢á≠©ñãÁ∑û®è¶©ãæ¢ä¨‰Éµ¢∂ëË¢∏™ú•∞∏õÈ∞û†èµ¶Ωπ©å¥ÈÅ∞´§µ¢ûØÔøΩËïôËïôÂóöÆáì≠≥õ≠∫∫Áà®„Æß¶£ΩËá∂Ë§ÑÈ∏∂§æ§±àù‰óñ†Üú®∂ÑÁñÑ¢Ç£†Ä™§®É•úò™âä™Ωú≠§ãÆ©≠§íê¨ÇãË¢ÖØ¢Ü©ê≤∞èï∞øüÁèîßãÉÔ™¥¶£©≠Ü¥°óã®éπÆé≥‰†††ê´§≤∞¶óâ®©©‰¢úÆïã≠ªä†è∂®úá†Åë´ÜØ≠≤∞™ã¥Æ°™¢Ñ©§ÇÉ¨ã¢•õ∏‰ó°‰ó°®≠§´±Æ„üÜ≠á¢§ëé¶Æµ©ï§È≥ß≠îåÁÖÖ°ÑÅ•≠ø¨ãÖ†®¶™¶ã¶Çî´î¥Ø£ìÊû≠°öñ¨™ô®∂± 
∞∫£‰ëµÊßù£ß∫®∞îÔ©´∞¨∏Ê®∫„¶äÊêó•âº©è≤≠ΩÇ£û¶¶æõ©ªÆ©æ£≠∂Çßí¨¶£µÈäåßõï≠≥©¶Äí†Üó£±≠Æë®´∫Ñ£™É¶ñ∂„Ç≥∞îáË§≠£Ñí¶ºπ¨§ù¶∑†¢¢ê®óº∞èº´üÅ°†ÑÁÑâ®±∏∞ëµ¶ªá´ø£ÊØ∑Ëêã®Ü¥°ªÖ©øã¨Ü∏®Ñõ©ãã†Ω†Ø§††ãê°ª∫Ë∫è´ìì≠µπ∞•°´Ñç®èºÁ©üÓ†óÔºü£ìç≠ú§ÊΩì°©ù¶éÆÂª™ß¥á§≥©¢ä£Áôù°ôûÂ¶ª„∫∫ßë∫≠åæ®£Ñ≠Ä•
†ÄÑ≠µà™ØúÂÜí°´õÂ£à∞æ∂¨ºó©é∂Â´ãÈúã•íõÂ∏¥¨°á∞ê£‚ñ≥§≤àÁû±È∑ç‚ë£§íπ°üº¢ãèÈîª®¨ã©Æü™µï¨∞∂¨áµÂªó†ôí∞í•Áπê‚ëßÂáÑ≠Ñê¢≥ö†å∂∞úä°´åËèØ•óó©åó©ï¥´≥ñßÅÅ´ëÉ∞çè°ù£°Ñâ¶æ∞•©∑•õµßµøßΩû™óç¶¶∫ÔøΩ©áÜ´≠áÂôùÂôù´ûå™≥¶≠ôô´∑Ä∞òÄ´åà™™®Á¶ÄÁÉè≠Ü©∞ííÂØ°´®¨§é≠´ñ§∞Åø®´ç„®∂„Øõ°ë©°Öì°ã¨©∏∏™•º 
£ê©†¨£‚ë•£≠å¨Öå≠±©†ïö´ãÇ§í¢™±á≠öêÆßµ¶∂Ä™£ã•®ó≠≠ß≠§™°ö£°ìî®Ωñ®è∏™ºö¨æπ¶¶æ®∫Ω´âøÁ©ó´∏º≠¶¢Áµª„¶ÖßΩã¢Ω¢§∂ê£¶®´π≤∞°πË≠ì„ÅÑ´ëæ¨∫°„ÇµÂ¥º§¥ò≠∏Ø§èëß¶Æ•ÑΩ§´É™†à†èüËó∫ßëç≠à≠ÂÜî†Ç∂≠ñò≠Æ¥Âµ®≠Öç¢°ò‰æüßøó¢µ¥ÂÜë¨üè®û∂™ü•°â†•§ÜÊáò´∞°¢äá´è¶ÁÜ∂¢Åé†•ñßéö°úõ™éê¢â∫≠≥òÊ§õÆ≠π„Çä
´Çµ†Üñ™¶≠≠´øÁ∏Ä§îû§∏º‰ôö§∫°¶™†¢∑çß∑ÉÆîô‰Æâ®Æç¢ÑìÁ¢´£¢î≠ÆñÊØà¶á†´ë¥Â≤ø´Ñä†éñ≠æä≠Åü‚ë´†éë∞≤ü°Ä´™≤í≠ûõÈÉ™£πÇ†°º∞¨ú†òê§âê™üä‚ë©†©ø†™ï†ïñ¶≥ì§àä†©ª°áæ´≤â•ªº†Ü£°ÄÆ„°å´â©¨©û∞∏ößÇΩ¶ã§¶∞å¢ä∏¢∫´‚ë§•ï†ßúµ®ø©¨ã°≠ûï™•Ä°πô´Öû≠á©ÊÉ†°ùΩ§äª¢Öä§••®îï´Üµ¨üò©æì°ÄÄ£éã„†°´ÖÜ°àò£¥Å
Æãç∞ß¨ÈöØÂµΩ•çô¶òéÊÆ¢ÆûÖ§ûê¢èª¶æèÂ≥å†ï¨¢ûªÊç£Ê§¥ß±äÁëÅ‰ï≤°´éÊëï£πã§¢§´®ª¢∂∏„±≠Ø£í§å∞•à®ÆíÆ∞å¨°ªúÈöù¶æì´åø§ä≥¢ã±≠ºæÊ™Å§Ü°©Üê≠©©Â≥∂®û¥Æò•Èü°Ê™©ßìÇ‚ëÆ≠¨¢Ê£≤„†è„±ï†Ü°©Ç≤„•£ÈäØ‚ë®Á∑Ä≠Ü±Â∑ã≠ñ∏Â∏∂£òñ≠°à¶îÄ¢∑≠Ëü™™∑∫ÁÑ®®ìº¶õä¶Ö†ß°ï©ΩÉ£ç´¶µç¨ùÇ≠ñ≤„úµ‰≥ã§™ßÂãñ¢Å§≠≤ÄÔøΩ¢õ°§è∑ÂáõÂáõ´èó™Éë™¶Ç£ùÑ®∫ú¢ßù¶Öµ†ûÜ™¶æ°ºÑ©èß¨üâ§áü´õì†ìÆÆÑ£°É¶°öÖÂÉ°Ë≠Å¨∏¥Ê∫©´¶±≠∏ûÆîíÊì£©éÇ©è¨©õñ¨øªÆî∞£§ùÁëñ°íÑ≠ö°ÁØ∂¶ΩèÊæï„Çà§Øë®ñÆ£∏∞§Åú£ß±Æ£ùË≥µ¢¥∂≠•üÆöä¶Üö´Ω≤Ôß∞£öù®üè¢∏£®∫ÜÊ†´ßïî°π≠Ø§ú¢®ñ¢∞Ç´≤≥†µÑÊ¥ä∞Ñï‚ë¢Œ±†ï¶∞ú¨†àö≠ΩÅ≠å®¨ÄòÂ´£ÈÑ°¢§∫¶ø¨£©ô∞ñ©†ç©‚ÜîÔøΩ
¨óãËÖ∂ËÖ∂´ΩêÆïπ©Éä•õ£´¥ò≠¥∫¢ôÆ„õø¢§≠∞èì≠ªü¢Ωµ™≤™§ãõ≠Ω∂¨ö≠°è≠Â¨ΩËπ∏¨í¢Æîú¶Ç∞ß¨Ωßüæ∞ºæ•†åÂá´Ëâí≠óÉ™Ñù§ëñ©º§Æì†¨û∂•†ÇÁë¶Èüâ∞ªÜ•ûò™æ´≠øñÂ¨ù§ëì†≥ß≠ô∫Ëçê®òõ
[I 220626 18:07:19 HeZi:39] epoch:5 base:1760 --> 1719 
[I 220626 18:07:20 HeZi:36] giveup:0 
[I 220626 18:07:21 HeZi:39] epoch:6 base:1719 --> 1719 
[I 220626 18:07:21 HeZi:36] giveup:0 
[I 220626 18:07:22 HeZi:39] epoch:7 base:1719 --> 1719 
[I 220626 18:07:22 HeZi:100] 
"""

"""
[I 220626 18:08:50 HeZi:36] giveup:0 
[I 220626 18:08:51 HeZi:39] epoch:0 base:12939 --> 9944 
[I 220626 18:08:51 HeZi:36] giveup:0 
[I 220626 18:08:52 HeZi:39] epoch:1 base:9944 --> 9831 
[I 220626 18:08:52 HeZi:36] giveup:0 
[I 220626 18:08:53 HeZi:39] epoch:2 base:9831 --> 9831 
[I 220626 18:08:53 HeZi:36] giveup:0 
[I 220626 18:08:54 HeZi:39] epoch:3 base:9831 --> 9831 
[I 220626 18:08:54 HeZi:36] giveup:0 
[I 220626 18:08:55 HeZi:39] epoch:4 base:9831 --> 9831 
[I 220626 18:08:56 HeZi:36] giveup:316 †∞ü£•ãõÇ¶£ß∫Æ°™‚ÜîÆÖè®ΩÖ¨ª•†©ø°Öì†™ï¢Å§¶îÄßïî†¨∑•ï†•íõ¢∫¨≠Ä•∞®á¶ñ∂•®ó≠Ω∂„Çà°££°üº≠ΩÅ≠ê£§îû¢á≠´ëÄ®≠§ßÖç©çΩ§Ω™ß±ä£∏º≠Öç≠ñ≤‚ë´£™ÉßÜïÆóô†®¶ÔøΩ©ΩÉ™ÇóÆé≥´∏Ä≠±Ω°ÖÅ©ÉÖ‚Ñì‚Ñì®ñÆ°ØºÆîáßÅÅ§®ÉÆáìÆ≠π‚ë†≠¥∫Æë©Æî∞Œ±¶™¥ÔøΩ‚ë©‚ë©£¢î‚ë§¨ÖåÆØÜ≠ê•©Éä¨æπ≠Æñ°©ù„ÅÑ¨óã†ó©£è±Æöä£ç´°ô™§ÇÉßøó§å∞¶áÖ∞ê£Â¨Ω‰Æâ§••≠ΩÇ¨ª±≠ú§‚ë¶ßòß‚ñ≥´öÉÆ£®£ó´Êåî®Ñõ†ÖÇ≠è¨£ß±§èë†¢®¨ªû£ê¶¶°ø†åö†≥ßÆïã‚ë°†Üó¢ßùßë∫™†àÆ¢á≠§ã†ê´≠´ø¨üè§≤±≠£û≠ªã•ëØ≠Ü±‚ëÆ´è¶≠©©≠Åü≠µà¶∞å≠©ü¶òé®±∏¶∑†®í¢≠á¢‚ë™≠Ñê¨ªë≠±©ß°ï¢Åé¢èª©•ú¢ªÄ´ÜØ´∏™•ÆÇÆíø‚ë¨•ÑΩ´ìì≠±é¶£µ©Æü§ï¶ßü∫„Çä¢äá∞í•©õñ¶óâ°Ñâ´∫Ñ®òÑ≠îåÆì†≠£™¨Ñí≠¶Å†ùâß∑ß™¶ÇÆÉûß¶ÆÆíÆ‰¶Ñ≠°à¨úª†ç©≠ö°Æ°≠„≠ö†¨£≠ß¢´¥¢≠≤û°ã¨≠™ö©úù®Äî≠£ï•≠ø°ôû£¥Å°ΩºÆûÖ¶£©°öÖ´Öû™õÉÔøΩ•©∑¶áµ≠¨¢£û¶°öá°êù©éá¨øª„É®„É®™ä©‚ë¢®îï‚ëØ®ìÇ§úì£ìùß°â•çôßÉ±§¥òßìÇÆ£ùÓ†ó≠©≤≠≥ò≠î•Æì¢£∫ôÆúü£∏∞¨ã¢§ãõ‚ë•‚ë≤ 
∞≤û†Üñ¢ã±Æîú£≠å´©ä≠≥©„Çµ´íØ≠∂Ç≠Åê£ñ∫†∞á§Åú¶Æµ£§ù•æ≥≠ôß≠µÑ≠¶¢Ôºü≠ôô¶Ø§‚ë≠†≤Å≠∫∫°≠≥≠ªä≠Ü¥¨ÖÖ≠ä∞≠ºæ‚ë£¢®ñ≠æä≠±êßüæ¶çñ‚ë®¨ùÇ≠Ä£†Ä™¨ªò≠¨çß∑Ñ§âê„Ç≥≠Æ¥¨î®¨ÉÖÆÑ£¢â∫†∞°©åÆ≠á©™¶æ´§µ‚ëß®∞î†ãê†éñ‚Ü∑´ëÉ´≠£¢Æ¥£ëõßÇò≠≠ß≠•ü≠§™ß¥á†Üã≠≥õ
[I 220626 18:08:57 HeZi:39] epoch:5 base:9831 --> 9799 
[I 220626 18:08:57 HeZi:36] giveup:0 
[I 220626 18:08:58 HeZi:39] epoch:6 base:9799 --> 9799 
[I 220626 18:08:58 HeZi:36] giveup:0 
[I 220626 18:08:59 HeZi:39] epoch:7 base:9799 --> 9799 
[I 220626 18:08:59 HeZi:100] 
"""

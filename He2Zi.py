from logzero import logger

star = 'Èñµ'

"""
    §çΩ	§ëî k,v  ÂºÇ‰ΩìÂ≠ó\tÊú¨‰ΩìÂ≠ó
    HeZi[§ëî]=HeZi[§çΩ] if §çΩ in §ëî
    HeZi[v]=HeZi[k] if k in v
    """


def split(dic0, JiZi, YiTi, epoch=0):
    giveup = set()
    dic1 = {}
    for k, v in dic0.items():
        if k == star:
            d = 0
        if k in giveup:
            continue
        if v in JiZi:
            dic1[k] = v
            continue
        u = ''
        for x in v:
            w = dic0[x]
            if w not in JiZi:
                w = YiTi.get(w, w)
                if epoch >= 5:
                    giveup.add(k)
                    # logger.info((k, v))
            u += w.strip()
        dic1[k] = u
        for x in giveup:
            if x in dic1:
                del dic1[x]
    logger.info(f"giveup:{len(giveup)} {''.join(giveup)}")
    base0 = set(''.join(x for x in dic0.values()))
    base1 = set(''.join(x for x in dic1.values()))
    logger.info((f"epoch:{epoch} base:{len(base0)} --> {len(base1)} "))
    return dic1


def chai(JiZi: list, ChaiZi: list, YiTiZi: list):
    HeZi = {k: v for k, v in ChaiZi}
    JiZi=set(x for x in JiZi if x in HeZi)
    for x in JiZi:
        HeZi[x] = x

    YiTi = {}
    for k, v in YiTiZi:
        if k == star:
            d = 0  # 'Â∏Ω'  Â±ÇÊ¨°ÊãÜÂ≠ó Êñ∞ÊûÑ‰ª∂
        if k in JiZi and v in JiZi:
            continue
        if k in JiZi and v not in JiZi:
            k = v
        YiTi[k] = v

    for k, v in YiTi.items():
        if v not in HeZi:  # vÁΩïËßÅ
            k, v = v, k
        if v not in HeZi:  # vÁΩïËßÅ
            logger.warning((k, v))
            continue
        if k in JiZi:
            continue
        if k in HeZi[v]:  # Êõ¥ÁªÜ
            HeZi[v] = HeZi[k]
        if v in HeZi:
            # if k < v:
            # logger.warning((k, v))
            HeZi[k] = HeZi[v]
        elif k in HeZi:  # None
            # logger.info((k, v)
            continue

    dic0 = {k: v for k, v in HeZi.items() if k and v}

    for i in range(8):
        dic1 = split(dic0, JiZi, YiTi, epoch=i)
        dic0 = dic1

    dic0 = {k: v for k, v in dic0.items() if k and v}
    return dic0


def build(JiZi, ChaiZiPath, YiTiZiPath,  HeZiPath, JiZiPath):
    JiZi = [x for x in JiZi if x]

    doc = open(YiTiZiPath).read().splitlines()
    YiTiZi = [x.split('\t') for x in doc]

    doc = open(ChaiZiPath).read().splitlines()
    ChaiZi = [x.split('\t') for x in doc]

    HeZi = chai(JiZi, ChaiZi, YiTiZi)

    Base = set(''.join(x for x in HeZi.values()))

    diff = Base-set(JiZi)
    logger.info(''.join(diff))  #
    assert len(diff) == 0

    Base = list(Base)
    Base.sort()
    with open(JiZiPath, "w") as f:
        for x in Base:
            f.write(x+'\n')

    chars = list(HeZi)
    chars.sort()
    with open(HeZiPath, "w") as f:
        for x in chars:
            l = f"{x}\t{HeZi[x]}"
            f.write(l+'\n')

    logger.info(f"HeZi build success -> {HeZiPath}  {JiZiPath}")


if __name__ == "__main__":
    JiZi = open("YuanZi/YuanZi.txt").read().splitlines()
    build(JiZi, ChaiZiPath="ChaiZi/ChaiZi.txt", YiTiZiPath="YiTiZi/YiTiZi.txt",
          HeZiPath="HeZi/He2Yuan.txt", JiZiPath="HeZi/YuanZi.txt")
    # JiZi = open("JiZi/JiZi.txt").read().splitlines()
    # build(JiZi, ChaiZiPath="ChaiZi/ChaiZi.txt", YiTiZiPath="YiTiZi/YiTiZi.txt",
    #       HeZiPath="HeZi/He2Ji.txt", JiZiPath="HeZi/JiZi.txt")


"""
[I 220626 19:01:53 HeZi:36] giveup:0 
[I 220626 19:01:54 HeZi:39] epoch:0 base:8204 --> 2611 
[I 220626 19:01:55 HeZi:36] giveup:0 
[I 220626 19:01:55 HeZi:39] epoch:1 base:2611 --> 1774 
[I 220626 19:01:56 HeZi:36] giveup:0 
[I 220626 19:01:57 HeZi:39] epoch:2 base:1774 --> 1760 
[I 220626 19:01:57 HeZi:36] giveup:0 
[I 220626 19:01:58 HeZi:39] epoch:3 base:1760 --> 1760 
[I 220626 19:01:58 HeZi:36] giveup:0 
[I 220626 19:01:59 HeZi:39] epoch:4 base:1760 --> 1760 
[I 220626 19:02:10 HeZi:36] giveup:1139 Á¥™†ïö¶¶æ≠æä®óºÁ∏Ä£¢î®èº™¨¢Áπê†àö†°ò´∂á©¶´´øù§ëñÊ¥ä©æí®¨ã§í¢§Ω™•¢Å≠öêÊªØ≠∫∫¢µ¥Âò©‚ë§ÂÜî£ùÑÈûØ¢Å§Ôß∞§èë¶¢µ´¥ò´∏™¢á≠Ê†´∞íí≠ñ∏£ß±°©º§ëì°ªÖ§¢§Ê¢ü™¶≠„™ûÆîí´èóÈüÄ©êØ„ØÇ®∂±Âú®´≠á∞∏õ°Ñâ®úë†≤Å≠±êÆÉûÂ≥å¢Öä
Â∂å•íõ†∞°¢ù™¶®ß•âºß†ÅßΩã†ûÜ©æì•çôÔºü¶Ö†°óã•††Ëπõ§é≠Ô¶é∞ñ©°íÑ´≠£¨óã¶†ú¶á†∞ú¨ÆØÜ†òÖ•óó¶Ωè‰ôä©æ£≠î•∞Åø„ÆßÓ†óß∑É¢∫¨®í¢•†å‚ë¢°öÖ°öáÈü¢®∞î≠è¨ÆíøÆîú†ïô§ëé≠£ûËü™Áû±‚ë°„Øä‚ë™¨ã¢Ë∫™ÔøΩ°úí°¨ú‰åØ‰åØÁµª≠¨ç≠å®≠≤ûÊØ∑¢ä£Âãñ§ûê™ü•¨∞∂´°ø¨ºóÆáìÂÜê∞≤û¢ÅéÊåî‚ë≤Â™¢Êáò®òÑ¶£Ω†èµ¢Ç£®∫£ 
≠•ü‚ë´Ëî∫ß±ä®∫ÜÂóöÈÉª£≠å„ÅÑ£©ô™¶Ç´ãáÂ¥ºÈñµ†è∂•ù©´®¨Â∂ã‰Éµ°ñ™Â∑ã‚ë≠ßÖç†ï¶´™Æ≠ªã„†°•§Çßéö≠´ø™µï¢≥ö§äª§éÑ∞øüÊ§¥ÊØàË∫è†™Ö•ïß†≠Ç•≤≠ÁÑ®§≤∞¨øª°Ωº†ãê¶õä´Üµ¢ä¨Âª©©ê≤´â©´è¶¨©û¨ü†§¥ò†Ä™ÔøΩ©ÄµÈÑ°ÈÑ°„•£´∞°†¨éË∫ô§®É™ûï®è∏Èîª¶æ∞Æì¢ÈÑ¢®ìºÆïπ†ïñ§è∑≠¶¢¢û®¢∂à¶Ø§‰¢ú¨ÑúÊ®∫£ª•  
Êç£Ëπ∏∞∞èÈöùÁ¢´§≥©∞Ø≥∞æ∂Æúü©ΩÉ©é∞£±≠¶ºØ„¶Ö®é∫©èß¨ö≠Æ©≠®∂ÑÊÆµ≠ô∫Ë§ÑõÇ¶§ãõÈÅ∞Â≥∂≠±Ω≠≠òÊáç£ù≤≠ΩÇ´©ä†©ª‰Öø‰≤∑¶ºπ¨Ø∂©ÉäÂá´ÆíÆÂ¨Ö§ÇÉß∑ß©ï§°ë©¶∂Ä„üÜ´®ª®ìÇÂ≤õ¨ö¶≠∏Ø™ã¥¨π¢„∫∫™±áÈ∂àÊÖ∏™£ãÊΩìßãÉ≠ö°§àÇßÆâ´íø†ª≠°úõ¨¨¢≠ΩÅ°©ù¢∂ëÆë®´ûºÊæü£ó´°êù´∫Ñ≠ªä•õ∏§å∞ÂΩí≠ìÅ‰††®ö≤ÔøΩ©æè´íØ©ù∑™üä¨∑∂‚ë®‚ë®¶áµ´ÜØ¨í¢Ëâú≠¥∫Â∏∂®â®©•ú©Ç≤†åµ°úà§≤±¶™¥®≠§®ò¨©åµÆò•ÁôùÂáõ®Ü¥„µØ§æèÂØ°°ñ†¶æõ¨°á®∫ΩÁÑâ°†ø°•Ç¨úªÈçõ¢ÑìÆ°≠Â≠òÂ´ã£ü¶„íø®ÆçÊëï¢à∫´∏ÄË≠Å‰ÉÄ°ø¢¶éÆ∞∫£°π≠Ê©ûßìÇ≠°£Ê∑í¶Ç∞Ë≠ìËµóÂ¨Ω‚ë¶§πÑÁºé´õì¨ä∑¢ä∏∞çè•à®Â¶ª°´õ‚Ñì¢ßù®ΩÖ™•ÄÈ°≤„•º∞Ñï∞¨∏´ëöËëÆ¨Äò¨ª±©ªÆÔøΩ†Åë¢æü£∑ëßÉ±∞äé°Ä´†µÑ‚ë£‚ë£∞¨¢¢èªØ§†∞òÄËá∂©ñã£∏º≠éØ©õñ°ªúËó∫Â£∫Êáî¶áÖß¥á®∫î®û¥©åó¨§ù∞ªÆÂ°Ö¢≥ÉÂáÑË£ä≠ä∞¨ªë≠ò≤°É¶°ôûßù•≠≤≥´¥¢≠Åü¨Ü∏Âª™†°º§Ç∂§àäßü∫¨Çã≠Ü±≠¨¢•ªº°ã¨≠µÑ¶ñ∂‰°ßÁÖÖ¢ùå©ã¶®îï™¶ã•§Ü¢ãè‰Æâ°†Ñß¶ÆÈè∏™Çó°â†Æîá¢ûØ≠à≠ßÅÅ£î∫°áæ©åÆ‚ëØ´Çµ™æ´≠ºæ†Ö§†ïÆ©çΩ∞¨úß°â´òô
≠ñò≠Ñê®ÑõÈ≥ß†éë•ï†°ÄÆ¢Ωµ¨üò∞∏ö´ëÄ°ö£ß∑Ñ§æ§¶¶∞§âêÂ∏Ω°™ç¶Äí°ô™®óç´ÉÖ∞èï≠±éßüæ¨ÑíßÜï≠ê•¨üèÊ£≤ÆÖè•æ≥¶∑†‰ñößû°¢†û¢Ø´¢∞Ç§∂ê§ö∂•ã∂Æöê°ùΩ¨êë≠Öç©âæ¨ãÖ¢∂∏¨ªû∞Çø„°å¶ºáÂãóËûê≠≥©¶∞å¨∏¥¢Ñ©ÂÜíÆé≥¨™ôÂ∏¥†ó©¶£©¢Ω¢„íü∞ê£‰âÆ†Ç∂†òüÊßùÂªó§∏º„úµÂÉ°Êæï°∫ë¢§î¢Øæ§Ü°ÂÜë•ûò®£Ñ¶çñÔøΩ§ä≥‰ôö‰ôöËçê≠∏ûËèØÊÆ¢™ºö©à∫≠Åê„∏ëÔ•î´öò≠Ä£™Øú¨ëì®´çÂ≤ø£∂Ä¢ôÆßõï¢¢ê´¶±©áÜ≠º™Æú©ÊÜì¨∫°™≥¶´ë¥´Ω≤£ØÄ‚ë©©èá†∞á„≠ö´∏º®û∂†¢®Æ≠πÁë¶¢ûªÂ£à¶ã§†ùâÂØ≠™†à°´é†®¶°ØºÈ∏∂¢ã¥Á©ü£è±£πÇ•®óßÇëÁÜ∂•ëØ≠Ü©ÁëÅÁëÅ®ñÆÂ°¢®ø©ÊúÇ©§£†å•∞ßøßòß™íúÔ®©Á®ü§ï¶ÈúãË¢∏´≤â¨î®§íπ†≥ß´¶≤≠óÉ™Ñù†Üã°´å
´öÉÆ£ù†ï¨≠Ä•™õÉ„Çµ„Çµ™≤™©ãæ£®º≠ß¢„±ï¶îÄËê∫È∑ç≠á¢£ìù£ªâ≠µà¢õ°´ìì≠ªü§™ßÁí§Êì££ß∫§≤à™ä©Ëâí¶òéÆÑ£†Üø†Üú£ìç§ìü´üÅßãçÆöä¢Æ¥¶∫ü†ìÆ°∑ä≠Æ¥È≥≥§Øë¢∏£§úì¶Çî´ñ§´ûå°≠≥´ÖÜ≠ñ≤≠™ö∞ß¨∞®á™∑§¶Üö†íé¨ùÇ≠©ü†≥≤≠§ã†Üó™∑∫ÊÉ†ÊÉ†¶ø¨¶Ωπ§íê†Ω†™™®„†è¢ªÄ°ìî¢∫´≠ªùÁÜì¢°ò´≤ÉÈ≥¨¶á©°üº¶Öµ 
≠¶ÅÆóô°ª∫´î¥§îûÆë©©é∂ß°ï¶°£´ÑäÆãç‰ï≤Áà®´ñõÆá≠∞ìö´≤≥∞üÄÈöØ™óç†ì∂†Ü°•ÆÇ†Üñ´ùµ†±Ω£û¶¨ä•≠ú§Øßä∞≤üÂÇø≠£ïÂíù£∏∞ÈÉ™ÁñÑ¢∑≠•á≥¶™†®è¶†âØ†±ú®∂á∞ºæ£éãÁØ∂´±Æ≠≥ò‚ëß‰≥ã¨ª•†Ü£´åà£§ù™Éë•©∑∞îá∞•°±Ä†´§µ†ò°ÁÉè®©©„¥ò™âä±àØ¢§≠´Ñç£Ü±ËûÆ£ç´®úá®™áÈé¢•£º†ÖÇ¢Ö¶„íª≠±©¢Ä§¢≠è£™ÉËêãÔ™¥
†åö´ø£¨îÑ¢ã±ÂÜÉ≠£™£∫èÈüâ¢®ñ©ãã©æñ‚ëÆ°àå™≤í´Ωê„†Ä°è≠´ãÇ†¶Ω®ΩñÈäå„±≠„íæ©ï¥„É®§´É£•ã≠≥õ§áü¶ÜâÊû≠≠Ω∂†∞ü©è≤§∫°´∑ÄÂµ®•õ£Á©ó‚ë¨¶ª∫Æ°™„Ç≥Æßµ§ì••õµÂµΩËùê„ºÆ¢äá§ëá‚ë†°æ≠¶Æµ±àùËΩ•Ô©´ÆïãË≥µ®üè≠∂Ç´Öû„¶ä¶™∑†¨∑Á∑û°†π§É¢Áá∑©è¨≠£®¶∑ä®òõÊ™Å„´Ø‰∏ù¨Öå¨ã°‰¶Ñ¢§Ö≠Æñ™¶æßøóÊ™©°àò£òñ
¶æì®Äî†éñÁëñ§ÄôÆ¢áÂáú°ÑÅ≠§™°ÄÄÈ¥µÊ§õ∞ëµ´≥ñ£πãÊ∫©¨æπ†ç©´Æñ≠åæ£∫ô‚Üî¶µç≠µπ™ú•≠≤∞†ï•ßÇò®∫ú¶óâ¢∑¨¢ÄÆ•≠ø´åø£Ñíßµø∞Öªßí¨¢û¨∞≠ç°âà¶Ä©Ë§≠®éπ‰óñ®≥Ä¨üâ≠©©ËÖ∂¶£µ©å¥£ëõ¨ÖÖ≠á©ÔøΩ≠∏õßë∫¶ëê≠ÇõÆî∞≠°à‚ñ≥‚ñ≥¢â∫‚ë•Á¶Ä¢•Å≠ûïßïîØ¢Ü´ëæÂòï≠ôß„Çà£øÜËïô£öùÂ´£°öñËüÇ´Ç†Áá£„®∂Èü°£ê¶£ñ∫•ÑΩ
¨µ™≠ûõËî´£å∞£üä¶°øØ£ìÆÉ¶ßÇΩ„íΩß†äÊºπ¢∑ç∞èº†™ï©ÜêßÉπ†¨£„õø°ºÑ°££©ÉÖ™Ωú£¶®§¥üËùÉ†ôíÁèî™•º´∫Ü∞úä¢≤Ñ©éÇÊêóÆì†£ª¥§£ΩÈ∑®≠ôôØ£í¨íõ†©ø¶äØÂÜï†òê®©∑°úå¨Äº†©Ø¶ªáÈäØ©éá∞Ç∂„Øõ¶¶∫ÔøΩ©èö†å∂È∞ûÈ∞û¢§∫‰ó°≠©≤ßÑü™àΩÈÑ•„ê≠ÂôùË¢Ö§çæÁôõ∞å¨≠Ü¥•úòßÇ∂∞°π„Çä§ÅúÂ∂π‚Ü∑§••†ÄÑ‰æüßΩû®í∏ 
´âøÁ∑ÄÆîôÊãµ‰ëµÂ£∑©úùß¨ΩßπÆ†ê´ÊÇΩ≠îå°πô©∏∏†èü≠≠ß´ëÉ©º§∞í•†õÜŒ±°ù£¢ãï£¥Å©Æü≠≤Ä£ëä™éê≠øñ∞èì•öï§°î¢¥∂¨òÑ∞ªÜ•©¥®Ä¨¨ÉÖ¨û∂‰ß•´π≤°ÖÅÂ¨ùßëç¶ãìÆ£®Êâóßöá≠ê£Ëå¨
[I 220626 19:02:10 HeZi:39] epoch:5 base:1760 --> 1719 
[I 220626 19:02:11 HeZi:36] giveup:0 
[I 220626 19:02:11 HeZi:39] epoch:6 base:1719 --> 1719 
[I 220626 19:02:12 HeZi:36] giveup:0 
[I 220626 19:02:13 HeZi:39] epoch:7 base:1719 --> 1719 
[I 220626 19:02:13 HeZi:100] 
[I 220626 19:02:13 HeZi:116] HeZi build success -> HeZi/He2Yuan.txt  HeZi/YuanZi.txt 
"""

"""

[I 220626 19:00:37 HeZi:36] giveup:0 
[I 220626 19:00:38 HeZi:39] epoch:0 base:12939 --> 9944
[I 220626 19:00:38 HeZi:36] giveup:0
[I 220626 19:00:39 HeZi:39] epoch:1 base:9944 --> 9831
[I 220626 19:00:39 HeZi:36] giveup:0
[I 220626 19:00:40 HeZi:39] epoch:2 base:9831 --> 9831
[I 220626 19:00:40 HeZi:36] giveup:0
[I 220626 19:00:40 HeZi:39] epoch:3 base:9831 --> 9831
[I 220626 19:00:41 HeZi:36] giveup:0
[I 220626 19:00:41 HeZi:39] epoch:4 base:9831 --> 9831
[I 220626 19:00:43 HeZi:36] giveup:316 Œ±Æïã‚ë™£ëõ‚ëÆ£•ã´ëÄ£∫è≠£û≠±©§èëÆë©≠îå≠•ü≠ä∞¶£©§å∞´π≤•≠ø™Çó≠±ΩÆî∞•ÑΩ¨ÉÖ≠á¢§Ω™ßÜïÆóôÆì¢´Öû≠µÑ°Øº‚ë®¨ª•≠æä¶£µ≠Åü†∞ü¶Ø§´≠£ßøó≠Åê§••¢®ñ¢á≠≠ö°´∏Ä†Üó¶Æµ≠î•¨Ñí†∞á®ìÇ‚ë¨≠∂Ç¶çñ£§ù‚ë≤≠¨¢ÆÉû≠Ü¥©úù£ìù≠£ï‚ë§≠µà†ãê¨ùÇ‚ëßßÉ±¨óã†åö≠è¨„ÅÑ§≤±≠´ø≠ªã¨úªÆûÖÆ≠π‚Ñì¢äá≠±é†≥ß¢èª£ß∫≠§ã≠ºæ´è¶≠Ä£≠¥∫‚ÜîßÖç≠ôß™õÉ°ô™„Çä≠∫∫≠ΩÇ®îï°öá§¥ò†ç©§âê¶îÄ°Ωº®±∏¨ÖÖ¢Å§≠ê•≠Ü±©Æü¨æπ©õñ§ÇÉÊåî§®É§ï¶ßìÇ®ñÆ≠á©ÔøΩ¨ªòõÇ¶Æúü©éáÆ£ù¶áµ°üº„Ç≥„Ç≥®òÑ≠Ñê„Çµ£™É†¨∑Æ°™†Üñ¨Öå≠≥ò•ï†≠≥õß∑Ñ°ã¨¨ºó§îûÔºüÆöä§úìß¥á‚ë°®≠§Æ¢á†™ï™†à 
≠©≤†∞°´ÜØ≠Öç≠§™‚ñ≥≠ß¢≠≤ûÆ£®¢â∫≠±ê‚ë≠©ÉÖÆØÜÆîú°êù´©ä‚ë¶‚ë•†®¶•©∑‚ë†∞®á°≠≥´¥¢°ôû£ê¶£∏∞≠¶Å„É®ÆíÆ„≠ö£ñ∫¶™¥¶òé°ÖÅÆáì¨øª£¢î≠°à©ΩÉ†¨£°Öì≠ê£‚ë©™ä©¨üèßü∫´ëÉ≠ñ≤´∫Ñ†ê´Â¨ΩßüæÔøΩ¶áÖÆì†©åÆÆé≥≠™ö≠Æ¥´ìì‚ë¢‚ë¢ßïî¢Åé•íõ≠Ä•≠©©∞ê£©•ú¨ªë•æ≥†©ø≠£™‚ëØß°â∞≤û§ãõ¨ª±°öÖ•®ó¶ñ∂‰¶Ñ£û¶≠ôô§Åúß°ï£ß±ÔøΩ¶∞åÆÖè≠ÆñÆíø¨ªû£ç´™¶Ç‚Ü∑‚Ü∑©çΩÆ°≠¢Æ¥¶°ø£∫ôß¶Æ†Ä™™¶æ‰Æâßë∫≠ªäÆÑ£®í¢ß∑ß≠©ü†Üã†ó©£è±£ó´ßÇò†ùâ•ëØ®Ñõ‚ë´°©ù†éñ¨¨¢†¢®ßÅÅÆîáßòß£¥Å¢ªÄß±ä¨ã¢≠¨ç•çô‚ë£≠¶¢†≤Å´∏™†ÖÇ£≠åÔøΩ•ÆÇ®Äî´íØ®∞î¶óâ°££´§µ¢∫¨≠≠ß£∏º¶∑†¨î®Ó†óÓ†ó®ΩÖ¢ßù¢ã±≠Ω∂„Çà°Ñâ©Éä
[I 220626 19:00:44 HeZi:39] epoch:5 base:9831 --> 9799
[I 220626 19:00:44 HeZi:36] giveup:0
[I 220626 19:00:45 HeZi:39] epoch:6 base:9799 --> 9799
[I 220626 19:00:45 HeZi:36] giveup:0
[I 220626 19:00:45 HeZi:39] epoch:7 base:9799 --> 9799
[I 220626 19:00:46 HeZi:100]
[I 220626 19:00:46 HeZi:116] HeZi build success -> HeZi/He2Ji.txt  HeZi/JiZi.txt
"""
